{% extends "store/base.html" %}
{% load static %}

{% block content %}



<div class="row">
  <!-- Sidebar Filters -->
  <aside class="col-md-3 mb-4">
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Filters</h5>
      </div>
      <div class="card-body">
        <form method="get">
          <!-- Filters... (unchanged) -->
          <div class="form-group">
            <label for="category">Category:</label>
            <select id="category" name="category" class="form-control">
              <option value="">All</option>
              {% for cat in categories %}
                <option value="{{ cat.id }}" {% if cat.id|stringformat:"s" == selected_category %}selected{% endif %}>{{ cat.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label for="subcategory">Subcategory:</label>
            <select id="subcategory" name="subcategory" class="form-control">
              <option value="">All</option>
              {% for sub in subcategories %}
                <option value="{{ sub.id }}" {% if sub.id|stringformat:"s" == selected_subcategory %}selected{% endif %}>{{ sub.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label for="brand">Brand:</label>
            <select id="brand" name="brand" class="form-control">
              <option value="">All</option>
              {% for b in brands %}
                <option value="{{ b.id }}" {% if b.id|stringformat:"s" == selected_brand %}selected{% endif %}>{{ b.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label for="rating">Min Rating:</label>
            <input type="number" id="rating" name="rating" class="form-control" placeholder="1-5" value="{{ rating }}">
          </div>

          <div class="form-group">
            <label for="search">Search:</label>
            <input type="text" id="search" name="search" class="form-control" value="{{ search_query }}">
          </div>

          <div class="form-group">
            <label for="special">Show only:</label>
            <select id="special" name="special" class="form-control">
              <option value="">All Items</option>
              <option value="new" {% if special == 'new' %}selected{% endif %}>New</option>
              <option value="bestseller" {% if special == 'bestseller' %}selected{% endif %}>Best Seller</option>
              <option value="in_stock" {% if special == 'in_stock' %}selected{% endif %}>In Stock</option>
              <option value="wishlist" {% if special == 'wishlist' %}selected{% endif %}>My Wishlist</option>
            </select>
          </div>

          <button type="submit" class="btn btn-primary btn-block">Apply Filters</button>
        </form>
      </div>
    </div>
  </aside>

  <!-- Item Cards -->
  <section class="col-md-9">
    <div class="row">
      {% for item in items %}
        <div class="col-md-6 col-lg-4 mb-4">
          <div class="card h-100 position-relative shadow-sm">

            <!-- Ribbons -->
            {% if item.discount_price and item.discount_expiry and item.discount_expiry > now %}
              <span class="badge badge-danger position-absolute" style="top:10px;right:10px;">-{{ item.discount_percent }}%</span>
              <span class="badge badge-warning position-absolute" style="top:10px;left:-15px;transform:rotate(-45deg);">Limited Time!</span>
            {% endif %}
            {% if item.is_featured %}
              <span class="badge badge-info position-absolute" style="top:45px;right:10px;">Best Seller</span>
            {% endif %}
            {% if item.created_at|date:"U" >= now|date:"U"|add:"-604800" %}
              <span class="badge badge-success position-absolute" style="top:75px;right:10px;">New</span>
            {% endif %}

            <!-- Image -->
            <div style="height: 250px; display: flex; justify-content: center; align-items: center; padding: 10px;">
              {% if item.image %}
                <img src="{{ item.image.url }}" alt="{{ item.name }}" style="max-height: 100%; max-width: 100%; object-fit: contain;" class="img-fluid mx-auto d-block">
              {% else %}
                <img src="{% static 'store/images/default.jpg' %}" alt="No image" class="img-fluid mx-auto d-block" style="max-height: 100%; max-width: 100%; object-fit: contain;">
              {% endif %}
            </div>

            <!-- Card Body -->
            <div class="card-body text-center">
              <h5 class="card-title font-weight-bold">{{ item.name }}</h5>

              {% if item.discount_price and item.discount_expiry and item.discount_expiry > now %}
                <p class="mb-1 text-danger font-weight-bold">
                  ${{ item.discount_price }} <small class="text-muted"><del>${{ item.price }}</del></small>
                </p>
                <small class="text-muted d-block">
                  <i class="far fa-clock"></i> Ends in: 
                  <span class="text-danger countdown" data-expiry="{{ item.discount_expiry.isoformat }}"></span>
                </small>
              {% else %}
                <p class="mb-1 font-weight-bold">${{ item.price }}</p>
              {% endif %}

              <p class="mb-1 text-muted">{{ item.subcategory.category.name }} > {{ item.subcategory.name }}</p>

              <!-- Rating -->
              <p class="mb-1">
                {% for i in "12345" %}
                  <i class="fas fa-star{% if forloop.counter > item.average_rating %}-o{% endif %} text-warning"></i>
                {% endfor %}
              </p>

              <p class="mb-0">
                {% if item.stock > 0 %}
                  <span class="badge badge-success">In Stock</span>
                {% else %}
                  <span class="badge badge-danger">Out of Stock</span>
                {% endif %}
              </p>
            </div>

            <!-- Footer Buttons -->
            <div class="card-footer bg-white border-0 d-flex justify-content-between">
              <a href="{% url 'item_detail' item.id %}" class="btn btn-outline-primary btn-sm">View</a>
              <form method="post" action="{% url 'add_to_cart' item.id %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-success">Add to Cart</button>
              </form>
            </div>
          </div>

          <!-- Wishlist Button -->
          {% if item.id in wishlist_ids %}
            <form action="{% url 'remove_from_wishlist' item.id %}" method="post">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-danger btn-block btn-sm mt-2">
                ❤️ Remove from Wishlist
              </button>
            </form>
          {% else %}
            <form action="{% url 'add_to_wishlist' item.id %}" method="post">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-danger btn-block btn-sm mt-2">
                ❤️ Add to Wishlist
              </button>
            </form>
          {% endif %}
        </div>
      {% empty %}
        <div class="col-12">
          <p>No items found matching your filters.</p>
        </div>
      {% endfor %}
    </div>
  </section>
</div>

<script>
  function updateCountdowns() {
    const now = new Date().getTime();
    document.querySelectorAll('.countdown').forEach(span => {
      const expiry = new Date(span.dataset.expiry).getTime();
      const diff = expiry - now;
      if (diff > 0) {
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        span.textContent = `${days}d ${hours}h ${minutes}m`;
      } else {
        span.textContent = "Expired";
      }
    });
  }
  setInterval(updateCountdowns, 60000);
  updateCountdowns();
</script>
{% endblock %}
